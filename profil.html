<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Korpost ‚Äì Profil</title>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBQLN3TI5pdzCnJ38YOAVBI-MG23ftdOeA",
            authDomain: "korpost-40bad.firebaseapp.com",
            projectId: "korpost-40bad",
            storageBucket: "korpost-40bad.firebasestorage.app",
            messagingSenderId: "571469681924",
            appId: "1:571469681924:web:7a61fad0455ec94836ec51"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;

        // Sichtbarkeit Umschalten
        function updateFormVisibility(type) {
            if (type === "person") {
                document.getElementById("person-section").style.display = "block";
                document.getElementById("verbindung-section").style.display = "none";
            } else {
                document.getElementById("person-section").style.display = "none";
                document.getElementById("verbindung-section").style.display = "block";
            }
        }

        // Beim Laden pr√ºfen, ob User eingeloggt ist
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "login.html";
            } else {
                currentUser = user;
                document.getElementById("user-email").textContent = user.email;
                loadProfile();
            }
        });

        async function loadProfile() {
            const ref = doc(db, "users", currentUser.uid);
            const snap = await getDoc(ref);

            if (snap.exists()) {
                const data = snap.data();

                document.getElementById("profileType").value = data.profileType || "person";
                updateFormVisibility(data.profileType);

                // Person Felder
                document.getElementById("vorname").value = data.vorname || "";
                document.getElementById("nachname").value = data.nachname || "";
                document.getElementById("nickname").value = data.nickname || "";
                document.getElementById("aktivstatus").value = data.aktivstatus || "";
                document.getElementById("verbindung").value = data.verbindung || "";

                // Verbindung Felder
                document.getElementById("verb-name").value = data.verbName || "";
                document.getElementById("dachverband").value = data.dachverband || "";

                // Gemeinsame Felder
                document.getElementById("land").value = data.land || "";
                document.getElementById("stadt").value = data.stadt || "";
                document.getElementById("adresse").value = data.adresse || "";
            }
        }

        async function saveProfile() {
            const type = document.getElementById("profileType").value;

            const ref = doc(db, "users", currentUser.uid);

            const data = {
                profileType: type,
                land: document.getElementById("land").value,
                stadt: document.getElementById("stadt").value,
                adresse: document.getElementById("adresse").value,
            };

            if (type === "person") {
                data.vorname = document.getElementById("vorname").value;
                data.nachname = document.getElementById("nachname").value;
                data.nickname = document.getElementById("nickname").value;
                data.aktivstatus = document.getElementById("aktivstatus").value;
                data.verbindung = document.getElementById("verbindung").value;
            } else {
                data.verbName = document.getElementById("verb-name").value;
                data.dachverband = document.getElementById("dachverband").value;
            }

            await setDoc(ref, data, { merge: true });

            alert("Profil gespeichert!");
        }

        async function logout() {
            await signOut(auth);
            window.location.href = "login.html";
        }

        window.updateFormVisibility = updateFormVisibility;
        window.saveProfile = saveProfile;
        window.logout = logout;

    </script>

    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .card { border: 1px solid #ccc; padding: 20px; border-radius: 8px; max-width: 600px; }
        label { font-weight: bold; }
        input, select { width: 100%; padding: 8px; margin-bottom: 12px; }
        button { padding: 10px 20px; margin-top: 10px; }
    </style>

</head>
<body>
<!-- NAVIGATION START -->
<style>
    /* Hintergrundoverlay */
    .nav-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.4);
        backdrop-filter: blur(2px);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
        z-index: 900;
    }

    .nav-overlay.open {
        opacity: 1;
        pointer-events: all;
    }

    /* Hamburger */
    .nav-container {
        position: fixed;
        top: 15px;
        right: 15px;
        z-index: 1100;
    }

    .nav-toggle {
        font-size: 34px;
        cursor: pointer;
        user-select: none;
        color: #333;
    }

    /* Panel */
    .nav-menu {
        position: fixed;
        top: 0;
        right: -320px;    /* geschlossen */
        width: 280px;
        max-width: 80%;
        height: 100%;
        background: #ffffff;
        box-shadow: -3px 0 8px rgba(0,0,0,0.2);
        padding: 25px;
        transition: right 0.3s ease;
        z-index: 1000;
    }

    .nav-menu.open {
        right: 0;        /* offen */
    }

    /* Links */
    .nav-menu a, 
    .nav-menu button {
        display: block;
        font-size: 20px;
        text-decoration: none;
        color: #222;
        margin: 18px 0;
        border: none;
        background: none;
        cursor: pointer;
        width: 100%;
        text-align: left;
    }

    .nav-menu a:hover,
    .nav-menu button:hover {
        color: #444;
    }

    /* Desktop-Optimierung */
    @media (min-width: 900px) {
        .nav-toggle {
            font-size: 32px;
        }
        .nav-menu {
            width: 300px;
        }
    }
</style>

<!-- Overlay -->
<div id="navOverlay" class="nav-overlay" onclick="closeMenu()"></div>

<!-- Hamburger Icon -->
<div class="nav-container">
    <span class="nav-toggle" onclick="toggleMenu()">‚ò∞</span>
</div>

<!-- Men√º -->
<div id="navMenu" class="nav-menu">
    <h3>üì¨ Korpost</h3>
    <hr>

    <a href="dashboard.html">üè† Dashboard</a>
    <a href="profil.html">üë§ Profil</a>
    <button onclick="logout()">üö™ Logout</button>
</div>

<script>
    function toggleMenu() {
        document.getElementById("navMenu").classList.toggle("open");
        document.getElementById("navOverlay").classList.toggle("open");
    }

    function closeMenu() {
        document.getElementById("navMenu").classList.remove("open");
        document.getElementById("navOverlay").classList.remove("open");
    }
</script>
<!-- NAVIGATION END -->

    <h2>Korpost ‚Äì Profil</h2>
    <p>Eingeloggt als: <span id="user-email"></span></p>
    <button onclick="logout()">Logout</button>
    <a href="dashboard.html">‚¨Ö Zur√ºck zum Dashboard</a>

    <hr>

    <div class="card">
        <h3>Profiltyp</h3>

        <label>Profil ist ein:</label>
        <select id="profileType" onchange="updateFormVisibility(this.value)">
            <option value="person">Einzelperson</option>
            <option value="verbindung">Verbindung</option>
        </select>

        <!-- PERSON -->
        <div id="person-section">
            <h3>Pers√∂nliches Profil</h3>

            <label>Vorname</label>
            <input id="vorname">

            <label>Nachname</label>
            <input id="nachname">

            <label>Nickname</label>
            <input id="nickname">

            <label>Aktivstatus</label>
            <select id="aktivstatus">
              <option value="Aktiv" selected>Aktiv</option>
              <option value="Philister">Philister</option>
            </select>

            </select>

            <label>Verbindung (Name)</label>
            <input id="verbindung">
        </div>

        <!-- VERBINDUNG -->
        <div id="verbindung-section" style="display:none;">
            <h3>Verbindungsprofil</h3>

            <label>Name der Verbindung</label>
            <input id="verb-name">

            <label>Dachverband</label>
            <input id="dachverband">
        </div>

        <!-- Gemeinsame Felder -->
        <h3>Allgemeine Angaben</h3>

        <label>Land</label>
        <input id="land">

        <label>Stadt</label>
        <input id="stadt">

        <label>Adresse</label>
        <input id="adresse">

        <button onclick="saveProfile()">üíæ Speichern</button>
    </div>

</body>
</html>
